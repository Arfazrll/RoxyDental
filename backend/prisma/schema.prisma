generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String          @id @default(uuid())
  username             String          @unique
  email                String          @unique
  passwordHash         String          @map("password_hash")
  role                 UserRole
  fullName             String          @map("full_name")
  phone                String         
  specialization       String?        
  isActive             Boolean         @default(true) @map("is_active")
  createdAt            DateTime        @default(now()) @map("created_at")
  updatedAt            DateTime        @updatedAt @map("updated_at")
  resetPasswordExpires DateTime?       @map("reset_password_expires")
  resetPasswordToken   String?         @map("reset_password_token")
  education            String?        
  experience           String?        
  profilePhoto         String?         @map("profile_photo")
  sipEndDate           DateTime?       @map("sip_end_date")
  sipNumber            String?         @map("sip_number")
  sipStartDate         DateTime?       @map("sip_start_date")
  commissions          Commission[]
  financeReports       FinanceReport[] @relation("UserFinanceReports")
  leaveApprovalsGiven  LeaveRequest[]  @relation("ApproverLeaveRequests")
  leaveRequests        LeaveRequest[]  @relation("UserLeaveRequests")
  packages             Package[]       @relation("UserPackages")
  procedures           Procedure[]     @relation("UserProcedures")
  schedules            Schedule[]
  treatmentsPerformed  Treatment[]     @relation("PerformedTreatments")
  visitsAsNurse        Visit[]         @relation("NurseVisits")

  @@index([role])
  @@index([isActive])
  @@index([email])
  @@map("users")
}

model Patient {
  id                  String      @id @default(uuid())
  patientNumber       String      @unique @map("patient_number")
  fullName            String      @map("full_name")
  dateOfBirth         DateTime    @map("date_of_birth")
  gender              Gender
  phone               String     
  email               String?    
  address             String?
  bloodType           String?     @map("blood_type")
  allergies           String?
  medicalHistory      String?     @map("medical_history")
  createdAt           DateTime    @default(now()) @map("created_at")
  updatedAt           DateTime    @updatedAt @map("updated_at")
  medicalRecordNumber String?     @unique @map("medical_record_number")
  treatments          Treatment[]
  visits              Visit[]

  @@index([patientNumber])
  @@index([fullName])
  @@index([phone])
  @@map("patients")
}

model Service {
  id              String          @id @default(uuid())
  serviceCode     String          @unique @map("service_code")
  serviceName     String          @map("service_name")
  category        ServiceCategory
  description     String?
  basePrice       Decimal         @map("base_price")
  commissionRate  Decimal         @map("commission_rate")
  durationMinutes Int?            @map("duration_minutes")
  isActive        Boolean         @default(true) @map("is_active")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @default(now()) @updatedAt @map("updated_at")
  treatments      Treatment[]

  @@index([category])
  @@index([isActive])
  @@index([serviceCode])
  @@map("services")
}

model FinanceReport {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  tipe          String  
  nama          String  
  prosedur      String? 
  potongan      Decimal  @default(0)
  bhpHarga      Decimal  @default(0) @map("bhp_harga")
  bhpKomisi     Decimal  @default(0) @map("bhp_komisi")
  farmasiHarga  Decimal  @default(0) @map("farmasi_harga")
  farmasiKomisi Decimal  @default(0) @map("farmasi_komisi")
  paketHarga    Decimal  @default(0) @map("paket_harga")
  paketKomisi   Decimal  @default(0) @map("paket_komisi")
  labHarga      Decimal  @default(0) @map("lab_harga")
  labKomisi     Decimal  @default(0) @map("lab_komisi")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  user          User     @relation("UserFinanceReports", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([nama])
  @@map("finance_reports")
}

model Procedure {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  name      String  
  code      String   @unique
  quantity  Int      @default(1)
  salePrice Decimal  @map("sale_price")
  avgComm   Decimal  @default(0) @map("avg_comm")
  totalSale Decimal  @map("total_sale")
  totalComm Decimal  @map("total_comm")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  user      User     @relation("UserProcedures", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([name])
  @@index([code])
  @@map("procedures")
}

model Package {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  name      String  
  sku       String   @unique
  quantity  Int      @default(1)
  salePrice Decimal  @map("sale_price")
  avgComm   Decimal  @default(0) @map("avg_comm")
  totalSale Decimal  @map("total_sale")
  totalComm Decimal  @map("total_comm")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  user      User     @relation("UserPackages", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([name])
  @@index([sku])
  @@map("packages")
}

model Visit {
  id             String      @id @default(uuid())
  patientId      String      @map("patient_id")
  nurseId        String      @map("nurse_id")
  visitNumber    String      @unique @map("visit_number")
  visitDate      DateTime    @map("visit_date")
  queueNumber    Int         @map("queue_number")
  status         VisitStatus @default(WAITING)
  chiefComplaint String?     @map("chief_complaint")
  bloodPressure  String?     @map("blood_pressure")
  notes          String?
  totalCost      Decimal     @default(0) @map("total_cost")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")
  payments       Payment[]
  treatments     Treatment[]
  nurse          User        @relation("NurseVisits", fields: [nurseId], references: [id])
  patient        Patient     @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([nurseId])
  @@index([visitDate])
  @@index([status])
  @@index([queueNumber])
  @@map("visits")
}

model Treatment {
  id             String       @id @default(uuid())
  visitId        String       @map("visit_id")
  patientId      String       @map("patient_id")
  serviceId      String       @map("service_id")
  performedBy    String       @map("performed_by")
  toothNumber    String?      @map("tooth_number")
  diagnosis      String?
  treatmentNotes String?      @map("treatment_notes")
  quantity       Int          @default(1)
  unitPrice      Decimal      @map("unit_price")
  discount       Decimal      @default(0)
  subtotal       Decimal      @map("subtotal")
  images         String[]
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  commissions    Commission[]
  patient        Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  performer      User         @relation("PerformedTreatments", fields: [performedBy], references: [id])
  service        Service      @relation(fields: [serviceId], references: [id])
  visit          Visit        @relation(fields: [visitId], references: [id], onDelete: Cascade)

  @@index([visitId])
  @@index([patientId])
  @@index([serviceId])
  @@index([performedBy])
  @@index([createdAt])
  @@map("treatments")
}

model Payment {
  id              String        @id @default(uuid())
  visitId         String        @map("visit_id")
  paymentNumber   String        @unique @map("payment_number")
  paymentDate     DateTime      @map("payment_date")
  paymentMethod   PaymentMethod @map("payment_method")
  amount          Decimal      
  paidAmount      Decimal       @map("paid_amount")
  changeAmount    Decimal       @default(0) @map("change_amount")
  status          PaymentStatus @default(PENDING)
  referenceNumber String?       @map("reference_number")
  notes           String?
  createdAt       DateTime      @default(now()) @map("created_at")
  visit           Visit         @relation(fields: [visitId], references: [id], onDelete: Cascade)

  @@index([visitId])
  @@index([paymentDate])
  @@index([status])
  @@index([paymentNumber])
  @@map("payments")
}

model Schedule {
  id                String       @id @default(uuid())
  userId            String       @map("user_id")
  title             String      
  description       String?
  scheduleType      ScheduleType @map("schedule_type")
  startDatetime     DateTime     @map("start_datetime")
  endDatetime       DateTime     @map("end_datetime")
  location          String?     
  isRecurring       Boolean      @default(false) @map("is_recurring")
  recurrencePattern String?      @map("recurrence_pattern")
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([startDatetime])
  @@index([scheduleType])
  @@map("schedules")
}

model LeaveRequest {
  id              String      @id @default(uuid())
  userId          String      @map("user_id")
  approvedBy      String?     @map("approved_by")
  startDate       DateTime    @map("start_date")
  endDate         DateTime    @map("end_date")
  leaveType       LeaveType   @map("leave_type")
  reason          String
  status          LeaveStatus @default(PENDING)
  rejectionReason String?     @map("rejection_reason")
  approvedAt      DateTime?   @map("approved_at")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")
  approver        User?       @relation("ApproverLeaveRequests", fields: [approvedBy], references: [id])
  requester       User        @relation("UserLeaveRequests", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([approvedBy])
  @@index([status])
  @@index([startDate])
  @@map("leave_requests")
}

model Commission {
  id               String           @id @default(uuid())
  userId           String           @map("user_id")
  treatmentId      String           @map("treatment_id")
  baseAmount       Decimal          @map("base_amount")
  commissionRate   Decimal          @map("commission_rate")
  commissionAmount Decimal          @map("commission_amount")
  periodMonth      Int              @map("period_month")
  periodYear       Int              @map("period_year")
  status           CommissionStatus @default(PENDING)
  paidAt           DateTime?        @map("paid_at")
  notes            String?
  createdAt        DateTime         @default(now()) @map("created_at")
  treatment        Treatment        @relation(fields: [treatmentId], references: [id], onDelete: Cascade)
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([treatmentId])
  @@index([periodMonth, periodYear])
  @@index([status])
  @@map("commissions")
}

enum UserRole {
  DOKTER
  PERAWAT
}

enum Gender {
  L
  P
}

enum VisitStatus {
  WAITING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ServiceCategory {
  CONSULTATION
  SCALING
  FILLING
  EXTRACTION
  WHITENING
  ORTHODONTIC
  OTHER
}

enum ScheduleType {
  SHIFT
  MEETING
  ACTIVITY
}

enum LeaveType {
  SICK
  ANNUAL
  EMERGENCY
  UNPAID
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PaymentMethod {
  CASH
  TRANSFER
  CARD
  QRIS
}

enum PaymentStatus {
  PENDING
  PAID
  PARTIAL
  REFUNDED
}

enum CommissionStatus {
  PENDING
  PAID
}
